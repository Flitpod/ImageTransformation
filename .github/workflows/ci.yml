name: CI Pipeline

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  # ============================================
  # STAGE 1: BUILD
  # ============================================

  build-cpp:
    name: Build C++ Projects (MinGW)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make

      - name: Build NativeCore (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make

      - name: Build NativeCore.Test (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make

      - name: Upload C++ build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build
          path: |
            NativeCore/build/Release/x64/
            NativeCore.Test/build/Release/x64/
          retention-days: 1

  # ============================================
  # STAGE 2: CODE QUALITY ANALYSIS
  # ============================================
  quality-dotnet-format:
    name: .NET Code Formatting
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      - run: dotnet tool install -g dotnet-format
      - name: Check formatting & annotate
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic Core/Core.csproj 2>&1 | ForEach-Object {
            if ($_ -match '^(.*?):(\d+):(\d+): (.*)') {
              $f,$l,$c,$m = $matches[1..4]
              Write-Host "::warning file=$f,line=$l,col=$c::$m"
            }
          } || true
          dotnet format --verify-no-changes --verbosity diagnostic Core.Tests/Core.Tests.csproj 2>&1 | ForEach-Object {
            if ($_ -match '^(.*?):(\d+):(\d+): (.*)') {
              $f,$l,$c,$m = $matches[1..4]
              Write-Host "::warning file=$f,line=$l,col=$c::$m"
            }
          } || true
          dotnet format --verify-no-changes --verbosity diagnostic App_wpf/App_wpf.csproj 2>&1 | ForEach-Object {
            if ($_ -match '^(.*?):(\d+):(\d+): (.*)') {
              $f,$l,$c,$m = $matches[1..4]
              Write-Host "::warning file=$f,line=$l,col=$c::$m"
            }
          } || true

  quality-dotnet-analyzers:
    name: .NET Code Analyzers
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      - run: dotnet restore Core/Core.csproj
      - run: dotnet restore Core.Tests/Core.Tests.csproj
      - name: Run analyzers & upload SARIF
        run: |
          mkdir sarif
          dotnet build Core/Core.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:ReportAnalyzer=true /p:RunAnalyzers=true /p:AnalyzerDiagnosticOutput=sarif /p:AnalyzerResultsPath=sarif/core.sarif
          dotnet build Core.Tests/Core.Tests.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:ReportAnalyzer=true /p:RunAnalyzers=true /p:AnalyzerDiagnosticOutput=sarif /p:AnalyzerResultsPath=sarif/tests.sarif
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/*.sarif

  quality-cpp-format:
    name: C++ Code Formatting
    runs-on: windows-latest
    needs: [build-cpp]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: choco install llvm -y
      - name: Check NativeCore
        run: |
          $err = $false
          Get-ChildItem -Path NativeCore -Include *.cpp,*.h,*.hpp -Recurse |
            Where-Object { $_.FullName -notmatch '\\build\\' } |
            ForEach-Object {
              clang-format --dry-run --Werror $_.FullName 2>$null
              if ($LASTEXITCODE) {
                Write-Host "::warning file=$($_.FullName)::Formatting error"
                $err = $true
              }
            }
          if ($err) { exit 1 }
      - name: Check NativeCore.Test
        run: |
          $err = $false
          Get-ChildItem -Path NativeCore.Test -Include *.cpp,*.h,*.hpp -Recurse |
            Where-Object { $_.FullName -notmatch '\\build\\' } |
            ForEach-Object {
              clang-format --dry-run --Werror $_.FullName 2>$null
              if ($LASTEXITCODE) {
                Write-Host "::warning file=$($_.FullName)::Formatting error"
                $err = $true
              }
            }
          if ($err) { exit 1 }

  quality-cpp-cppcheck:
    name: C++ Static Analysis (cppcheck)
    runs-on: windows-latest
    needs: [build-cpp]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: mingw-w64-x86_64-cppcheck
      - name: Run cppcheck NativeCore
        shell: msys2 {0}
        run: cppcheck --enable=all --inline-suppr --suppress=missingIncludeSystem --xml --xml-version=2 --output-file=cppcheck-nativecore.xml NativeCore 2>&1
      - name: Run cppcheck NativeCore.Test
        shell: msys2 {0}
        run: cppcheck --enable=all --inline-suppr --suppress=missingIncludeSystem --xml --xml-version=2 --output-file=cppcheck-test.xml NativeCore.Test 2>&1
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cppcheck-reports
          path: cppcheck-*.xml
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: cppcheck-*.xml

  # ============================================
  # STAGE 3: TESTS
  # ============================================
  test-dotnet:
    name: Run .NET Unit Tests (NUnit)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Restore dependencies
        run: dotnet restore Core.Tests/Core.Tests.csproj

      - name: Run Core.Tests (NUnit)
        run: |
          dotnet test Core.Tests/Core.Tests.csproj `
            --configuration Release `
            --logger "trx;LogFileName=nunit-results.trx" `
            --results-directory ./TestResults `
            --verbosity normal

      - name: Publish .NET Test Results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          check_name: .NET NUnit Test Results
          files: 'TestResults/*.trx'
          report_individual_runs: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-test-results
          path: TestResults/

  test-cpp:
    name: Run C++ Unit Tests (Google Test)
    runs-on: windows-latest
    needs: [build-cpp]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake

      - name: Download C++ build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cpp-build
          path: artifacts/cpp

      - name: Copy artifacts to build directory
        shell: msys2 {0}
        run: |
          mkdir -p NativeCore/build/Release/x64
          mkdir -p NativeCore.Test/build/Release/x64
          cp -r artifacts/cpp/NativeCore/build/Release/x64/* NativeCore/build/Release/x64/ || true
          cp -r artifacts/cpp/NativeCore.Test/build/Release/x64/* NativeCore.Test/build/Release/x64/ || true

      - name: Run NativeCore.Test (Google Test)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test/build/Release/x64
          ./NativeCore.Test.exe --gtest_color=yes --gtest_output=xml:gtest-results.xml

      - name: Publish C++ Test Results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          check_name: C++ Google Test Results
          files: '**/gtest-results.xml'
          report_individual_runs: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cpp-test-results
          path: NativeCore.Test/build/Release/x64/gtest-results.xml

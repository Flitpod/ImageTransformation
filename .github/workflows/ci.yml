name: CI Pipeline

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch
  workflow_dispatch:  # Allows manual trigger

jobs:
  # ============================================
  # STAGE 1: BUILD
  # ============================================
  build-dotnet:
    name: Build .NET Projects
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Build Core
        run: dotnet build Core/Core.csproj -c Release -v minimal
      
      - name: Build Core.Tests
        run: dotnet build Core.Tests/Core.Tests.csproj -c Release -v minimal
      
      - name: Upload .NET build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-build
          path: |
            Core/bin/Release/
            Core.Tests/bin/Release/
          retention-days: 1

  build-cpp:
    name: Build C++ Projects (MinGW)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make
      
      - name: Build NativeCore (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make
      
      - name: Build NativeCore.Test (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make
      
      - name: Upload C++ build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build
          path: |
            NativeCore/build/Release/x64/
            NativeCore.Test/build/Release/x64/
          retention-days: 1

  # ============================================
  # STAGE 2: CODE QUALITY ANALYSIS
  # ============================================
  quality-dotnet-format:
    name: .NET Code Formatting
    runs-on: windows-latest
    needs: build-dotnet
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format
      
      - name: Check Core formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic Core/Core.csproj
        continue-on-error: true
      
      - name: Check Core.Tests formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic Core.Tests/Core.Tests.csproj
        continue-on-error: true

  quality-dotnet-analyzers:
    name: .NET Code Analyzers
    runs-on: windows-latest
    needs: build-dotnet
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Run .NET Analyzers on Core
        run: dotnet build Core/Core.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:TreatWarningsAsErrors=false
      
      - name: Run .NET Analyzers on Core.Tests
        run: dotnet build Core.Tests/Core.Tests.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:TreatWarningsAsErrors=false

  quality-cpp-cppcheck:
    name: C++ Static Analysis (cppcheck)
    runs-on: windows-latest
    needs: build-cpp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install cppcheck
        run: choco install cppcheck -y
      
      - name: Run cppcheck on NativeCore
        run: |
          cppcheck --enable=all --inconclusive --suppress=missingIncludeSystem `
            --xml --xml-version=2 --output-file=cppcheck-nativecore.xml `
            --project=NativeCore/CMakeLists.txt `
            NativeCore 2>&1
        continue-on-error: true
      
      - name: Run cppcheck on NativeCore.Test
        run: |
          cppcheck --enable=all --inconclusive --suppress=missingIncludeSystem `
            --xml --xml-version=2 --output-file=cppcheck-test.xml `
            --project=NativeCore.Test/CMakeLists.txt `
            NativeCore.Test 2>&1
        continue-on-error: true
      
      - name: Upload cppcheck reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cppcheck-reports
          path: |
            cppcheck-nativecore.xml
            cppcheck-test.xml

  quality-cpp-format:
    name: C++ Code Formatting
    runs-on: windows-latest
    needs: build-cpp
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install clang-format
        run: choco install llvm -y
      
      - name: Check NativeCore formatting
        run: |
          $files = Get-ChildItem -Path NativeCore -Include *.cpp,*.h,*.hpp -Recurse | Where-Object { $_.FullName -notmatch '\\build\\' }
          $exitCode = 0
          foreach ($file in $files) {
            Write-Host "Checking $($file.FullName)"
            clang-format --dry-run --Werror $file.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              $exitCode = 1
            }
          }
          if ($exitCode -ne 0) {
            Write-Host "::warning::C++ formatting issues detected in NativeCore"
          }
          exit $exitCode
        continue-on-error: true
      
      - name: Check NativeCore.Test formatting
        run: |
          $files = Get-ChildItem -Path NativeCore.Test -Include *.cpp,*.h,*.hpp -Recurse | Where-Object { $_.FullName -notmatch '\\build\\' }
          $exitCode = 0
          foreach ($file in $files) {
            Write-Host "Checking $($file.FullName)"
            clang-format --dry-run --Werror $file.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              $exitCode = 1
            }
          }
          if ($exitCode -ne 0) {
            Write-Host "::warning::C++ formatting issues detected in NativeCore.Test"
          }
          exit $exitCode
        continue-on-error: true

  # ============================================
  # STAGE 3: TESTS
  # ============================================
  test-dotnet:
    name: Run .NET Unit Tests (NUnit)
    runs-on: windows-latest
    needs: [build-dotnet]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Download .NET build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build
      
      - name: Restore dependencies
        run: dotnet restore Core.Tests/Core.Tests.csproj
      
      - name: Run Core.Tests (NUnit)
        run: |
          dotnet test Core.Tests/Core.Tests.csproj `
            --configuration Release `
            --no-build `
            --logger "trx;LogFileName=nunit-results.trx" `
            --results-directory ./TestResults `
            --verbosity normal
      
      - name: Publish .NET Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET NUnit Test Results
          path: 'TestResults/*.trx'
          reporter: dotnet-trx
          fail-on-error: true
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-test-results
          path: TestResults/

  test-cpp:
    name: Run C++ Unit Tests (Google Test)
    runs-on: windows-latest
    needs: [build-cpp]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
      
      - name: Download C++ build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cpp-build
          path: artifacts/cpp
      
      - name: Copy artifacts to build directory
        shell: msys2 {0}
        run: |
          mkdir -p NativeCore/build/Release/x64
          mkdir -p NativeCore.Test/build/Release/x64
          cp -r artifacts/cpp/NativeCore/build/Release/x64/* NativeCore/build/Release/x64/ || true
          cp -r artifacts/cpp/NativeCore.Test/build/Release/x64/* NativeCore.Test/build/Release/x64/ || true
      
      - name: Run NativeCore.Test (Google Test)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test/build/Release/x64
          ./NativeCore.Test.exe --gtest_color=yes --gtest_output=xml:gtest-results.xml
      
      - name: Publish C++ Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: C++ Google Test Results
          path: '**/gtest-results.xml'
          reporter: java-junit
          fail-on-error: true
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cpp-test-results
          path: NativeCore.Test/build/Release/x64/gtest-results.xml

  # ============================================
  # STAGE 4: SUMMARY
  # ============================================
  summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test-dotnet, test-cpp]
    if: always()
    
    steps:
      - name: Check build status
        id: check-build
        run: |
          echo "dotnet_test=${{ needs.test-dotnet.result }}" >> $GITHUB_OUTPUT
          echo "cpp_test=${{ needs.test-cpp.result }}" >> $GITHUB_OUTPUT
      
      - name: Generate summary
        run: |
          echo "## ðŸ”„ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ—ï¸ Build Stage" >> $GITHUB_STEP_SUMMARY
          echo "| Project | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Core + Core.Tests (.NET 6) | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| NativeCore + NativeCore.Test (C++ MinGW) | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Code Quality Stage" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| .NET Code Formatting (dotnet-format) | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| .NET Code Analyzers | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| C++ Static Analysis (cppcheck) | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| C++ Code Formatting (clang-format) | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ§ª Test Stage" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-dotnet.result }}" == "success" ]]; then
            echo "| Core.Tests (NUnit) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Core.Tests (NUnit) | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-cpp.result }}" == "success" ]]; then
            echo "| NativeCore.Test (Google Test) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| NativeCore.Test (Google Test) | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-dotnet.result }}" == "failure" ]] || [[ "${{ needs.test-cpp.result }}" == "failure" ]]; then
            echo "### âŒ CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more test suites failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… CI Pipeline Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All builds, quality checks, and tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
name: CI Pipeline

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ============================================
  # STAGE 1: BUILD
  # ============================================
  build-dotnet:
    name: Build .NET Projects
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Build Core
        run: dotnet build Core/Core.csproj -c Release -v minimal

      - name: Build Core.Tests
        run: dotnet build Core.Tests/Core.Tests.csproj -c Release -v minimal

      - name: Build App_wpf
        run: dotnet build App_wpf/App_wpf.csproj -c Release -v minimal

      - name: Upload .NET build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-build
          path: |
            Core/bin/Release/
            Core.Tests/bin/Release/
          retention-days: 1

  build-cpp:
    name: Build C++ Projects (MinGW)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make

      - name: Build NativeCore (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make

      - name: Build NativeCore.Test (Release)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -S . -B ./build/make/make_release
          cd ./build/make/make_release
          mingw32-make

      - name: Upload C++ build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build
          path: |
            NativeCore/build/Release/x64/
            NativeCore.Test/build/Release/x64/
          retention-days: 1

  # ============================================
  # STAGE 2: CODE QUALITY ANALYSIS
  # ============================================
  quality-dotnet-format:
    name: .NET Code Formatting
    runs-on: windows-latest
    needs: build-dotnet
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format

      - name: Check Core formatting
        run: dotnet format --verify-no-changes --verbosity minimal Core/Core.csproj

      - name: Check Core.Tests formatting
        run: dotnet format --verify-no-changes --verbosity minimal Core.Tests/Core.Tests.csproj

      - name: Check App_wpf formatting
        run: dotnet format --verify-no-changes --verbosity minimal App_wpf/App_wpf.csproj

  quality-dotnet-analyzers:
    name: .NET Code Analyzers
    runs-on: windows-latest
    needs: build-dotnet
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Restore Core dependencies
        run: dotnet restore Core/Core.csproj

      - name: Restore Core.Tests dependencies
        run: dotnet restore Core.Tests/Core.Tests.csproj

      - name: Run .NET Analyzers on Core
        run: dotnet build Core/Core.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:TreatWarningsAsErrors=false

      - name: Run .NET Analyzers on Core.Tests
        run: dotnet build Core.Tests/Core.Tests.csproj -c Release --no-restore /p:EnforceCodeStyleInBuild=true /p:AnalysisLevel=latest /p:TreatWarningsAsErrors=false

  quality-cpp-format:
    name: C++ Code Formatting
    runs-on: windows-latest
    needs: build-cpp
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: choco install llvm -y

      - name: Check NativeCore formatting
        run: |
          $files = Get-ChildItem -Path NativeCore -Include *.cpp,*.h,*.hpp -Recurse | Where-Object { $_.FullName -notmatch '\\build\\' }
          $hasErrors = $false
          foreach ($file in $files) {
            $output = clang-format --dry-run --Werror $file.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Formatting issue in: $($file.FullName)"
              $hasErrors = $true
            }
          }
          if ($hasErrors) {
            Write-Host "::error::NativeCore has formatting issues. Run 'clang-format -i' on the files."
            exit 1
          }

      - name: Check NativeCore.Test formatting
        run: |
          $files = Get-ChildItem -Path NativeCore.Test -Include *.cpp,*.h,*.hpp -Recurse | Where-Object { $_.FullName -notmatch '\\build\\' }
          $hasErrors = $false
          foreach ($file in $files) {
            $output = clang-format --dry-run --Werror $file.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Formatting issue in: $($file.FullName)"
              $hasErrors = $true
            }
          }
          if ($hasErrors) {
            Write-Host "::error::NativeCore.Test has formatting issues. Run 'clang-format -i' on the files."
            exit 1
          }

  quality-cpp-cppcheck:
    name: C++ Static Analysis (cppcheck)
    runs-on: windows-latest
    needs: build-cpp
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 for cppcheck
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: mingw-w64-x86_64-cppcheck

      - name: Run cppcheck on NativeCore
        shell: msys2 {0}
        run: |
          cppcheck --enable=warning,style,performance,portability `
            --inline-suppr `
            --suppress=missingIncludeSystem `
            --error-exitcode=1 `
            --xml --xml-version=2 --output-file=cppcheck-nativecore.xml `
            NativeCore 2>&1

      - name: Run cppcheck on NativeCore.Test
        shell: msys2 {0}
        run: |
          cppcheck --enable=warning,style,performance,portability `
            --inline-suppr `
            --suppress=missingIncludeSystem `
            --error-exitcode=1 `
            --xml --xml-version=2 --output-file=cppcheck-test.xml `
            NativeCore.Test 2>&1

      - name: Upload cppcheck reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cppcheck-reports
          path: |
            cppcheck-nativecore.xml
            cppcheck-test.xml

  # ============================================
  # STAGE 3: TESTS
  # ============================================
  test-dotnet:
    name: Run .NET Unit Tests (NUnit)
    runs-on: windows-latest
    needs: [build-dotnet]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Download .NET build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build

      - name: Restore dependencies
        run: dotnet restore Core.Tests/Core.Tests.csproj

      - name: Run Core.Tests (NUnit)
        run: |
          dotnet test Core.Tests/Core.Tests.csproj `
            --configuration Release `
            --no-build `
            --logger "trx;LogFileName=nunit-results.trx" `
            --results-directory ./TestResults `
            --verbosity normal

      - name: Publish .NET Test Results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          check_name: .NET NUnit Test Results
          files: 'TestResults/*.trx'
          report_individual_runs: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-test-results
          path: TestResults/

  test-cpp:
    name: Run C++ Unit Tests (Google Test)
    runs-on: windows-latest
    needs: [build-cpp]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 with MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake

      - name: Download C++ build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cpp-build
          path: artifacts/cpp

      - name: Copy artifacts to build directory
        shell: msys2 {0}
        run: |
          mkdir -p NativeCore/build/Release/x64
          mkdir -p NativeCore.Test/build/Release/x64
          cp -r artifacts/cpp/NativeCore/build/Release/x64/* NativeCore/build/Release/x64/ || true
          cp -r artifacts/cpp/NativeCore.Test/build/Release/x64/* NativeCore.Test/build/Release/x64/ || true

      - name: Run NativeCore.Test (Google Test)
        shell: msys2 {0}
        run: |
          cd NativeCore.Test/build/Release/x64
          ./NativeCore.Test.exe --gtest_color=yes --gtest_output=xml:gtest-results.xml

      - name: Publish C++ Test Results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          check_name: C++ Google Test Results
          files: '**/gtest-results.xml'
          report_individual_runs: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cpp-test-results
          path: NativeCore.Test/build/Release/x64/gtest-results.xml
